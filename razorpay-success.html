<script>
  /* 0️⃣  local snapshot you stored before redirecting */
  const local = JSON.parse(sessionStorage.getItem("pendingOrder") || "{}");

  /* 1️⃣  read Razorpay query-string */
  const q     = new URLSearchParams(location.search);
  const payId = q.get("razorpay_payment_id");
  const ordId = q.get("razorpay_order_id");
  const sign  = q.get("razorpay_signature");

  /* 2️⃣  buyer cancelled or PayPal failed → skip verification */
  if (!payId) {
    sessionStorage.removeItem("pendingOrder");
    location.replace("/#paymentCancelled");   // show your own “cancelled” view
    return;
  }

  /* 3️⃣  payment succeeded → verify & store order on Firestore */
  fetch("/.netlify/functions/verify-signature", {
    method : "POST",
    headers: { "Content-Type": "application/json" },
    body   : JSON.stringify({
      payId, ordId, sign,
      ...local                // cart, addr, uid, totals
    })
  })
  .then(() => {
    sessionStorage.removeItem("pendingOrder");
    location.href = "/#paymentSuccess";
  })
  .catch(() => location.href = "/#paymentError");
</script>